<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login + FCM í…ŒìŠ¤íŠ¸</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
</head>
<body>
<h1>ğŸ” ë¡œê·¸ì¸ + FCM í…ŒìŠ¤íŠ¸</h1>

<form id="login-form">
    <label>Email: <input type="email" name="email" required></label><br>
    <label>Password: <input type="password" name="password" required></label><br>
    <button type="submit">ë¡œê·¸ì¸</button>
</form>



<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAaqBkYM4a69GlaVda6b2c651wfJTyeRLk",
        authDomain: "taste-web-push.firebaseapp.com",
        projectId: "taste-web-push",
        storageBucket: "taste-web-push.firebasestorage.app",
        messagingSenderId: "62821911150",
        appId: "1:62821911150:web:db6a0df9ca7d4e439ef47f",
        measurementId: "G-5GGMJ81LTC"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    const form = document.getElementById('login-form');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = form.email.value;
        const password = form.password.value;

        // ë¡œê·¸ì¸ ìš”ì²­
        const loginResponse = await fetch('/auth/signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, password}),
            credentials: 'include'  // ì„¸ì…˜ ì¿ í‚¤ ì „ë‹¬ í•„ìˆ˜
        });

        if (!loginResponse.ok) {
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            return;
        }

        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ');

        // ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
        const registration = await navigator.serviceWorker.register('sw.js');
        console.log('âœ… ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ ì™„ë£Œ');

        // ì„œë¹„ìŠ¤ ì›Œì»¤ê°€ í™œì„±í™”ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
        await registration.ready;
        console.log('âœ… ì„œë¹„ìŠ¤ì›Œì»¤ í™œì„±í™” ì™„ë£Œ');

        // FCM í† í° ìš”ì²­
        try {
            const fcmToken = await messaging.getToken({ serviceWorkerRegistration: registration });
            console.log('âœ… FCM ë“±ë¡ í† í°:', fcmToken);

            // ì„œë²„ì— FCM í† í° ì „ì†¡
            await fetch('/web-push/subscribe', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ fcmToken: fcmToken }),
                credentials: 'include'
            });

            alert('ğŸ‰ êµ¬ë… ì™„ë£Œ! ì´ì œ ì„œë²„ì—ì„œ ì•Œë¦¼ì„ ë³´ë‚´ë³´ì„¸ìš”.');
        } catch (error) {
            console.error('FCM í† í° ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ì„œë²„ ì „ì†¡ ì‹¤íŒ¨:', error);
            alert('FCM êµ¬ë… ì‹¤íŒ¨: ' + error.message);
        }
    });

    // í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­: ë¸Œë¼ìš°ì €ê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œ ì•Œë¦¼ì„ ë°›ì„ ë•Œ)
    messaging.onMessage(function(payload) {
        console.log('Message received in foreground. ', payload);
        // í¬ê·¸ë¼ìš´ë“œì—ì„œëŠ” OS ì•Œë¦¼ë§Œ í‘œì‹œí•˜ë„ë¡ ë³€ê²½
        const notificationTitle = payload.notification.title || 'ìƒˆ ì•Œë¦¼';
        const notificationBody = payload.notification.body || 'ë‚´ìš© ì—†ìŒ';
        const notificationImage = payload.notification.image || null;
        const notificationIcon = payload.notification.icon || '/firebase-image.png'; // ê¸°ë³¸ ì•„ì´ì½˜ ì‚¬ìš©

        const notificationOptions = {
            body: notificationBody,
            icon: notificationIcon,
            data: payload.data
        };

        if (notificationImage) {
            notificationOptions.image = notificationImage;
        }

        // Check if notification permission is granted
        if (Notification.permission === 'granted') {
            new Notification(notificationTitle, notificationOptions);
        } else if (Notification.permission !== 'denied') {
            // Request permission if not already granted or denied
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    new Notification(notificationTitle, notificationOptions);
                }
            });
        }
    });

</script>
</body>
</html>
