<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Login + Web Push í…ŒìŠ¤íŠ¸</title>
</head>
<body>
<h1>ğŸ” ë¡œê·¸ì¸ + Web Push í…ŒìŠ¤íŠ¸</h1>

<form id="login-form">
    <label>Email: <input type="email" name="email" required></label><br>
    <label>Password: <input type="password" name="password" required></label><br>
    <button type="submit">ë¡œê·¸ì¸</button>
</form>

<script>
    // base64url ì¸ì½”ë”© í•¨ìˆ˜
    const form = document.getElementById('login-form');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = form.email.value;
        const password = form.password.value;

        // ë¡œê·¸ì¸ ìš”ì²­
        const loginResponse = await fetch('/auth/signin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email, password}),
            credentials: 'include'  // ì„¸ì…˜ ì¿ í‚¤ ì „ë‹¬ í•„ìˆ˜
        });

        if (!loginResponse.ok) {
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            return;
        }

        const loginData = await loginResponse.json();
        const vapidPublicKey = loginData.data.vapidPublicKey;

        console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ, ê³µê°œí‚¤:', vapidPublicKey);

        // ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡
        const reg = await navigator.serviceWorker.register('sw.js');
        console.log('âœ… ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ ì™„ë£Œ');

        const swRegistration = await navigator.serviceWorker.ready;
        console.log('âœ… ì„œë¹„ìŠ¤ì›Œì»¤ í™œì„±í™” ì™„ë£Œ');

        // Push êµ¬ë…
        const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
        });

        console.log('âœ… ë¸Œë¼ìš°ì € êµ¬ë… ì •ë³´:', sub);

        const subscriptionData = {
            endPoint: sub.endpoint,
            keys: {
                p256dh: arrayBufferToBase64Url(sub.getKey("p256dh")),
                auth: arrayBufferToBase64Url(sub.getKey("auth"))
            }
        };

        console.log("âœ… ì„œë²„ë¡œ ë³´ë‚¼ êµ¬ë… ì •ë³´:", subscriptionData);

        // ì„œë²„ì— êµ¬ë… ì •ë³´ ì „ì†¡
        await fetch('/web-push/subscribe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(subscriptionData),
            credentials: 'include'
        });

        alert('ğŸ‰ êµ¬ë… ì™„ë£Œ! ì´ì œ ì„œë²„ì—ì„œ ì•Œë¦¼ì„ ë³´ë‚´ë³´ì„¸ìš”.');
    });

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    function arrayBufferToBase64Url(buffer) {
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
</script>
</body>
</html>
